<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ClienteB - Reproducción</title>
  <style>
    /* Mantenemos los estilos originales con pequeñas mejoras */
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      color: white;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #mediaContainer {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .mediaItem {
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }
    .mediaItem.active {
      opacity: 1;
    }
    .mediaItem img, .mediaItem video {
      object-fit: cover;
      width: 100%;
      height: 100%;
    }
    .vertical-pair {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .vertical-pair .mediaItem {
      position: relative;
      width: 50%;
      height: 100%;
      overflow: hidden;
    }
    .vertical-pair .mediaItem img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      animation: moveVertical 25s linear;
    }
    @keyframes moveVertical {
      0% { transform: translateY(0); }
      100% { transform: translateY(calc(-100% + 100vh)); }
    }
    #clock {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    #clock .time {
      font-size: 80px;
      font-weight: bold;
    }
    #clock .date {
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div id="mediaContainer"></div>
  <div id="clock">
    <div class="time" aria-live="polite"></div>
    <div class="date" aria-live="polite"></div>
  </div>
  <script>
    let mediaFiles = [];
    let currentIndex = 0;
    let isPlaying = true;

    // 1. Mejorado: Sistema de carga de medios con validación
    function fetchSelectedPhotos() {
      try {
        const stored = localStorage.getItem('selectedPhotos');
        if (stored) {
          const parsed = JSON.parse(stored);
          mediaFiles = parsed.filter(item => 
            item?.id && item?.url && item.url.startsWith('http')
          );
          console.log('Medios cargados:', mediaFiles);
        }
      } catch (error) {
        console.error('Error cargando medios:', error);
      }
    }

    // 2. Mejorado: Manejo de elementos multimedia con CORS
    function createMediaElement(fileObj) {
      const mediaItem = document.createElement('div');
      mediaItem.className = 'mediaItem';
      
      const isVideo = fileObj.type?.includes('video') || 
                     ['mp4', 'avi', 'mov'].some(ext => fileObj.url.toLowerCase().endsWith(`.${ext}`));

      if (isVideo) {
        const video = document.createElement('video');
        video.src = fileObj.url;
        video.crossOrigin = "anonymous";
        video.muted = true;
        video.playsInline = true;
        video.autoplay = true;
        video.controls = false;
        video.style.objectFit = 'cover';
        
        video.addEventListener('loadeddata', () => {
          mediaItem.classList.add('active');
          video.play().catch(e => console.error('Error video:', e));
        });
        
        video.addEventListener('ended', () => {
          mediaItem.classList.remove('active');
        });

        mediaItem.appendChild(video);
      } else {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = fileObj.url;
        img.onload = () => {
          mediaItem.classList.add('active');
        };
        img.onerror = () => console.error('Error carga imagen:', fileObj.url);
        mediaItem.appendChild(img);
      }
      
      return mediaItem;
    }

    // 3. Mejorado: Detección de orientación con caché
    const orientationCache = new Map();
    async function getOrientation(fileObj) {
      if (!fileObj?.url) return 'horizontal';
      if (orientationCache.has(fileObj.id)) {
        return orientationCache.get(fileObj.id);
      }
      
      try {
        const url = new URL(fileObj.url);
        url.searchParams.set('w', '100');
        url.searchParams.set('h', '100');
        
        const orientation = await new Promise((resolve) => {
          const img = new Image();
          img.onload = () => resolve(img.naturalHeight > img.naturalWidth ? 'vertical' : 'horizontal');
          img.onerror = () => resolve('horizontal');
          img.src = url.toString();
        });
        
        orientationCache.set(fileObj.id, orientation);
        return orientation;
      } catch {
        return 'horizontal';
      }
    }

    // 4. Mejorado: Sistema de reproducción con gestión de estado
    async function playNext() {
      if (!mediaFiles.length || !isPlaying) return;
      
      const fileObj = mediaFiles[currentIndex];
      if (!fileObj) {
        currentIndex = (currentIndex + 1) % mediaFiles.length;
        return;
      }

      const orientation = await getOrientation(fileObj);
      let nextIndex = currentIndex + 1;
      let pairElement = null;

      if (orientation === 'vertical' && nextIndex < mediaFiles.length) {
        const nextFile = mediaFiles[nextIndex];
        if (nextFile && (await getOrientation(nextFile)) === 'vertical') {
          pairElement = createVerticalPair(fileObj, nextFile);
          nextIndex++;
        }
      }

      const mediaElement = pairElement || createMediaElement(fileObj);
      const container = document.getElementById('mediaContainer');
      
      // Transición suave
      container.appendChild(mediaElement);
      setTimeout(() => {
        if (container.children.length > 1) {
          container.removeChild(container.children[0]);
        }
      }, 1000);

      // Calcular tiempo de visualización
      const isVideo = mediaElement.querySelector('video');
      const displayTime = isVideo ? 
        (mediaElement.querySelector('video').duration * 1000 || 8000) : 
        8000;

      await new Promise(resolve => setTimeout(resolve, displayTime + 1000));
      
      currentIndex = (nextIndex) % mediaFiles.length;
      playNext();
    }

    function createVerticalPair(fileObj1, fileObj2) {
      const pairContainer = document.createElement('div');
      pairContainer.className = 'vertical-pair';
      
      const item1 = createMediaElement(fileObj1);
      const item2 = createMediaElement(fileObj2);
      
      pairContainer.appendChild(item1);
      pairContainer.appendChild(item2);
      return pairContainer;
    }

    // 5. Mejorado: Actualización en tiempo real
    function setupLiveUpdates() {
      window.addEventListener('storage', (event) => {
        if (event.key === 'selectedPhotos') {
          orientationCache.clear();
          fetchSelectedPhotos();
          if (!isPlaying) {
            currentIndex = 0;
            playNext();
          }
        }
      });
    }

    // 6. Mejorado: Sistema de reloj
    function updateClock() {
      const now = new Date();
      const timeOptions = { hour: '2-digit', minute: '2-digit' };
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      
      document.querySelector('#clock .time').textContent = 
        now.toLocaleTimeString('es-ES', timeOptions);
      
      document.querySelector('#clock .date').textContent = 
        now.toLocaleDateString('es-ES', dateOptions);
    }

    // Inicialización
    window.onload = () => {
      fetchSelectedPhotos();
      setupLiveUpdates();
      updateClock();
      setInterval(updateClock, 1000);
      
      document.addEventListener('dblclick', () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
        }
      });
      
      // Iniciar reproducción
      playNext();
    };

    // Manejo de errores global
    window.addEventListener('error', (error) => {
      console.error('Error global:', error);
      isPlaying = false;
      setTimeout(() => {
        isPlaying = true;
        playNext();
      }, 5000);
    });
  </script>
</body>
</html>